<!-- 
<style>
  ::selection { background-color: Highlight; }
</style>
 -->
<div id="container" tabindex="-1">
  <p id="paragraph">This is a test of selecting text programmatically.</p>
</div>
<script>
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const container = document.getElementById('container');
  const paragraph = document.getElementById('paragraph');
  let previousSelectionRange = null;
  console.log(isSafari);
  
  container.addEventListener('pointerup', selectText);
  function selectText(event) {
    const selection = window.getSelection();
    const range = document.createRange();
    range.setStart(paragraph.firstChild, 15);
    range.setEnd(paragraph.firstChild, 34);
    selection.removeAllRanges();
    selection.addRange(range);
  }
  
  if (isSafari) {
    function getRangeFromTapEvent(event) {
      let range;
      if (document.caretPositionFromPoint) {
        // Most browsers (in case there are others that need the workaround)
        let caretPosition = document.caretPositionFromPoint(event.clientX, event.clientY);
        range = document.createRange();
        range.setStart(caretPosition.offsetNode, caretPosition.offset);
        range.collapse(true);
      } else if (document.caretRangeFromPoint) {
        // Safari
        range = document.caretRangeFromPoint(event.clientX, event.clientY);
      }
      return range;
    }
    container.addEventListener('pointerdown', createSelectionRange);
    function createSelectionRange() {
      let selection = window.getSelection();
      if (selection.type == 'None') {
        range = getRangeFromTapEvent(event);
        selection.addRange(range);
      }
    }
  
    document.addEventListener('selectionchange', (event) => debounce(savePreviousSelectionRange(event), 100));
    function savePreviousSelectionRange() {
      const selection = window.getSelection();
      console.log(selection.type);
      if (selection.type == 'Range') {
        previousSelectionRange = selection.getRangeAt(0).cloneRange()
      } else if (selection.type == 'Caret' && previousSelectionRange) {
        selection.removeAllRanges();
        selection.addRange(previousSelectionRange);
        previousSelectionRange = null;
      } else if (selection.type == 'None' && previousSelectionRange) {
        selection.addRange(previousSelectionRange);
        previousSelectionRange = null;
      }
    }
  }
  
  const debounce = (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
</script>
